
How to compute the telemetered maximum dose exposure trend.
-----------------------------------------------------------

----
ACIS
----

STEP 1:
-------
First, get month long cumulative exposure map from level 1 data.

perl /data/mta4/MTA/bin/acis_dose_get_data.perl <start_year> <start_month> <end_year> <end_month>

For example:

	 perl /data/mta4/MTA/bin/acis_dose_get_data.perl 2004 3 2004 3

to get Mar 2004 exposure map.

This will create ACIS_<month>_<year>.fits file (e.g., ACIS_03_2004.fits) in the directry 
you are working. 

Second, open the fits file with ds9, and examine the data. Go to "Scale", and select
"Scale Parameters". This will open up a histgram of count rate distribution. Estimate
an appropriate upper limit (e.g., at the point the continuous distribution starts). 

Thrid, use fimgtrim to remove any data point higher than the upper limit:

	fimgtrim infile=ACIS_MM_YYYY.fits outfile=out.fits  threshlo threshup const_lo const_up
	where:	threshlo: lower threshold (= 0)
		threshup: upper threshold --- the value you selected
		const_lo: a replace value for lower threshold (= 0)
		const_up: a replace value for upper threshold (= 0)

copy out.fit back to ACIS_MM_YYYY.fits
Save this file in /data/mta/www/mta_max_exp/Month/ (you should zip it).

STEP 2:
------
Go to /data/mta/www/mta_acis_sci_run, and open drop_<yyyy> and drop5x5_<yyyy>, and if there are any
high drop rate observations for the corresponding period, copy them into a file in a working directory.
Format of the input line should be:
#obsid  name                    start time      month   Int time        Inst    CCD     Grating Tot Cnt         Drop Rate 
1998    CRAB_NEBULA             353:72900.092   dec     25.8            ACIS-S  S1      NONE    403.922         39.3     

Except the month, all other entiries are from acis_sci_run. The month is added so that 
it is esay to see which data belong to which month later.

Then run:

	perl acis_dose_correct_drop_rate.perl <input_file>

This will create correction part in a direcotry ./Save (acisf*_img_part.fits and acisf*_img_full.fits.
The former contains only corrected part, the latter is a full image). Not all the data will creates a correction 
fits file, since some of them do not have any data on CCD s3. A combined image data is also created and 
named : comb_out.fits (contains only corretion part for the month). Use this file to correct the missing part. 
Note; if s3 CCD is empty, comb_out.fits will be corrupted; so make sure that s3 actually has data.
(5/4/05 the script is updated so that if there is no s3 obs. comb_out.fit won't be created.)

STEP 3:
------
Create separate images for CCDs I2, I3, S2, and S3
List names of fits files that you just created in a file (for example: fits_list),
then run:
	perl /data/mta4/MTA/bin/acis_dose_seprate_ccd.perl fits_list
where fits_list contains list of fits files (if it is for monthly only one fits file name).
This will creates separate images for I2, I3, S2, and S3.If the original
fits file has a name of: ACIS_08_2004.fits, then the resulted files are ACIS_08_2004_i2.fits etc.

Open each fits file with ds9 again, and trim unwanted upper part as you did in Step 1.


STEP 4:
------
Combine with the previous cumulative data: 

	/data/mta/www/mta_max_exp/Cumulative/ACIS_07_1999_<prev month>_<year>.fits.gz.

After unzip this, combine this with a new fits file.

	fimgmerge ACIS_07_1999_MM'_YYYY'.fits @file ACIS_07_1999_MM_YYYY.fits
	where: MM' is the previous month (e.g. 02);
	       YYYY' is the year for the previous month (e.g.2004)
	       MM  is this month (e.g. 03)
	       YYYY is the year for this month (e.g. 2004)
	       @file is a file containing line(s):
			ACIS_MM_YYYY.fits,0,0 (e.g. ACIS_03_2004.fits,0,0)
			comb_out.fits,0,0     (if a correction is required).

Do the same operations for ccd I2, I3, S2, and S3.

STEP 5:
------
Compute statistics:

perl /data/mta4/MTA/bin/acis_dose_extract_stat_data_month.perl <year> <month> <dir1> <dir2> <out_dir>

where:
	<year>: 	the year that you wnat to compute
	<month>:	the month that you want to compute
	<dir1>:		the directory containing a cumulative data fits file
	<dir2>:		the directory containing a this mounth's fits file
	<out_dir>:	output directory:  /data/mta/www/mta_max_exp/Data

This add this month's statistics to data files, e.g.
	i_3_n_0_acc_out: CCD I3 cumulative data
	i_3_n_0_dff_out: CCD I3 none cumulative data

If you want to compute the entire period (starting Jul 1999), use

perl /data/mta4/MTA/bin/hrc_dose_extract_stat_data.perl

for this, the cumulative data must be in ./Save directory, and monthly data must be
in ./Save/Data directory.


STEP 6:
-------
First, create plots fo these data:
perl /data/mta4/MTA/bin/acis_dose_plot_exposure_stat.perl <in_dir> <out_dir>

where:
	<in_dir>: input dir /data/mta/www/mta_max_exp/Data
	<out_dir>: output dir  /data/mta/www/mta_max_exp/Plots

Second, create html pages for data display
perl /data/mta4/MTA/bin/acis_dose_make_data_html.perl <in_dir>

where:
	<in_dir>: data directory, created html page will also save in the same directory.






---
HRC
---

Run following two scripts to get both center and full HRC dose maps. These are run automatically
(as cron jobs) on 3rd or every momth to create dose maps for the previous month.

perl /data/mta4/MTA/bin/hrc_create_center_dose_map.perl

perl /data/mta4/MTA/bin/hrc_create_full_dose_map.perl


####### OLD STEP BY STEP METHODS ########

Creation of the exposure maps for HRC is basically same as that of ACIS.

Step 1
------
Get data:

perl /data/mta4/MTA/bin/hrc_dose_get_data.perl <start_year> <start_month> <end_year> <end_month>

This will create two fits files (in Save/):
	HRCS_MM_YYYY.fits
	HRCI_MM_YYYY.fits

We do not do triming of data for HRC.


STEP 2
------
Combine with the previous cumulative data:

   /data/mta_www/mta_max_exp/Cumulative_hrc/HRCS_08_1999_<prev month>_<year>.fits.gz.
   /data/mta_www/mta_max_exp/Cumulative_hrc/HRCI_08_1999_<prev month>_<year>.fits.gz.

After unzip this, combine this with a new fits file.

        figmarge HRCS_08_1999_MM'_YYYY'.fits @file HRCS_08_1999_MM_YYYY.fits
        figmarge HRCI_08_1999_MM'_YYYY'.fits @file HRCS_0I_1999_MM_YYYY.fits

STEP 3
------
Compute statistics:

perl /data/mta4/MTA/bin/hrc_dose_extract_stat_data_month.perl <year> <month> <dir1> <dir2> <out_dir>

where:
        <year>:         the year that you wnat to compute
        <month>:        the month that you want to compute
        <dir1>:         the directory containing a cumulative data fits file
        <dir2>:         the directory containing a this mounth's fits file
        <out_dir>:      output directory:  /data/mta/www/mta_max_exp/Data



STEP 4
------
First, create plots fo these data:
perl /data/mta4/MTA/bin/hrc_dose_plot_exposure_stat.perl <in_dir> <out_dir>

where:
        <in_dir>: input dir /data/mta/www/mta_max_exp/Data
        <out_dir>: output dir  /data/mta/www/mta_max_exp/Plots

Second, create html pages for data display
perl /data/mta4/MTA/bin/hrc_dose_make_data_html.perl <in_dir>


The results can be observed at:
	
	http://asc.harvard.edu/mta_days/mta_max_exp/exposure.html


---------------------
HRC Full Exposure Map
---------------------
To create full exposure maps for HRC-I and HRC-S are done by following steps.

1. extract data from archive:
	perl hrc_dose_get_data_full_rage.perl <start year> <start month> <end year> <end month> <user> <pass> <out_dir>
	where:	<start year> <start month> starting year and month of data which you want to extract
		<end year> <end month>     ending year and month of data which you want to extract

		example: 2005 5 2005 5--- this extract data for the month of May 2005 only.
	
		<user> <pass> arc4gl 	   user name and password

		<out_dir>		   directory name where all hrc fits files go

2. create cumulative exposrue map for the month:
	perl hrc_dose_make_cum_add_to_last.perl <in_dir> <cum_dir> <year> <month>
	
	where <in_dir>		a directory name which saves monthly exposure maps
	      <cum_dir>         a directory name which saves cumulative exposrue maps
	      <year> <month>    year and month of which you want to create cumulative maps
				(you must have cumulative maps for the previous maps.)

3. compute statistics:
	perl hrc_dose_dff_comp_stat_month.perl <in_dir> <out_dir> <year> <month>
	perl hrc_dose_acc_comp_stat_month.perl <in_dir> <out_dir> <year> <month>

	where <in_dir> 		input directory name 
	      <out_dir>		output directory name--- this must contains previous output
				since this script append the new data to them.
	      <year> <month>    year and month of which you want to compute statistics.

4. plot trends:
	perl hrc_dose_plot_exposure_stat_section.perl <in_dir> <out_dir>

	where <in_dir>		output directory created by step 3
	      <out_dir>	        output directory for gif files

5. create data files for html:
	perl hrc_dose_make_data_html_full_range.perl <in_dir>

	where <in_dir>		output direcotory created by ste 3. The results will be
				saved in the same directory


-----------------
html page update
-----------------

perl dose_plot_html_for_plot.perl

This will update all html page (except for data html pages)
